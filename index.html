<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalPass Bus Pass System - Pakistan Routes</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Inter font and custom colors/shadows -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Inspired by Pakistan flag green
                        'primary': '#008000', 
                        'secondary': '#a7f3d0', // Light green accent
                        'bg-dark': '#0f172a',
                        'card-light': '#1e293b',
                    },
                    boxShadow: {
                        '3xl': '0 35px 60px -15px rgba(0, 0, 0, 0.5)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        /* Custom scrollbar for ticket history */
        #tickets-history::-webkit-scrollbar {
            width: 8px;
        }

        #tickets-history::-webkit-scrollbar-thumb {
            background-color: #008000; /* Primary green */
            border-radius: 4px;
        }

        #tickets-history::-webkit-scrollbar-track {
            background-color: #1e293b;
        }

        .seat-map-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 250px;
            margin: 20px auto;
        }

        .seat {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            border: 2px solid transparent;
            user-select: none;
        }

        .seat-available {
            background-color: #334155;
            color: #e2e8f0;
        }

        .seat-reserved {
            background-color: #ef4444;
            color: #ffffff;
            cursor: not-allowed;
        }

        .seat-selected {
            background-color: #008000; /* Primary green */
            color: #ffffff;
            border: 2px solid #a7f3d0;
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(0, 128, 0, 0.4);
        }
        
        /* Focus styles for inputs */
        input:focus, select:focus {
            border-color: #a7f3d0 !important;
            box-shadow: 0 0 0 3px rgba(167, 243, 208, 0.5);
        }
    </style>
    
    <script type="module">
        // --- LOCAL STORAGE FUNCTIONS ---
        const LOCAL_STORAGE_KEY = 'localpass_bus_tickets';

        /** Helper function for currency formatting (PKR without decimals) */
        function formatPrice(price) {
            return `Rs. ${price.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
        }

        /** Loads tickets from browser's local storage. */
        function loadTicketsFromLocalStorage() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            try {
                const tickets = data ? JSON.parse(data) : [];
                // Sort by creationTime (latest first)
                return tickets.sort((a, b) => b.creationTime - a.creationTime);
            } catch (e) {
                console.error("Error parsing tickets from local storage:", e);
                return [];
            }
        }

        /** Saves the current array of tickets to browser's local storage. */
        function saveTicketsToLocalStorage(tickets) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tickets));
            // Trigger UI update after saving
            renderTicketHistory();
        }

        // --- Core Application State & Logic ---
        window.appState = {
            selectedRoute: 'route_khi_isb',
            selectedDate: new Date().toISOString().split('T')[0],
            selectedSeat: null,
            isAuthReady: true, // Always true since no external auth is needed
            // Pakistani Routes and Prices (PKR) - Cities: Islamabad, Karachi, Lahore, Gujranwala, Narowal
            routes: {
                'route_khi_isb': { 
                    name: 'Karachi to Islamabad - Business Sleeper', 
                    price: 6000, 
                    seats: ['A1', 'A2', 'B1', 'B2', 'C1', 'C2', 'D1', 'D2', 'E1', 'E2'] 
                },
                'route_lhe_khi': { 
                    name: 'Lahore to Karachi - Executive Plus', 
                    price: 3500, 
                    seats: ['A1', 'A2', 'A3', 'A4', 'B1', 'B2', 'B3', 'B4', 'C1', 'C2', 'C3', 'C4'] 
                },
                'route_lhe_nwd': { 
                    name: 'Lahore to Narowal - Standard', 
                    price: 750, 
                    seats: ['A1', 'A2', 'A3', 'A4', 'B1', 'B2', 'B3', 'B4', 'C1', 'C2', 'C3', 'C4', 'D1', 'D2', 'D3', 'D4', 'E1', 'E2', 'E3', 'E4'] 
                },
                'route_grw_isb': { 
                    name: 'Gujranwala to Islamabad - Premium', 
                    price: 1500, 
                    seats: ['A1', 'A2', 'B1', 'B2', 'C1', 'C2', 'D1', 'D2', 'E1', 'E2', 'F1', 'F2'] 
                },
            },
            bookedSeats: {}, // { route_id: { date: [seats] } } - Simulated booked seats
            userTickets: [] // Local storage tickets
        };
        
        /** Handles the booking process and saves the ticket to Local Storage. */
        async function bookTicket() {
            const { selectedRoute, selectedDate, selectedSeat, routes } = window.appState;

            if (!selectedRoute || !selectedDate || !selectedSeat) {
                showModal("Please select a Route, Date, and Seat.");
                return;
            }

            const routeDetails = routes[selectedRoute];
            const creationTime = Date.now();
            const bookingId = `PK-${selectedRoute.split('_').slice(-2).join('').toUpperCase()}-${selectedSeat}-${creationTime.toString().slice(-6)}`;
            
            // Ticket Object (Stored locally)
            const newTicket = {
                routeId: selectedRoute,
                routeName: routeDetails.name,
                travelDate: selectedDate,
                seatNumber: selectedSeat,
                price: routeDetails.price,
                currency: 'PKR',
                bookingId: bookingId,
                creationTime: creationTime, // Used for sorting/history
            };

            const bookButton = document.getElementById('book-button');
            bookButton.disabled = true;
            bookButton.textContent = 'Saving...';

            try {
                // 1. Load existing tickets
                const existingTickets = loadTicketsFromLocalStorage();
                
                // 2. Check for duplicate local booking (basic prevention of accidental double-click)
                const isDuplicate = existingTickets.some(t => 
                    t.routeId === selectedRoute && 
                    t.travelDate === selectedDate && 
                    t.seatNumber === selectedSeat
                );

                if (isDuplicate) {
                    showModal("This exact ticket (Route/Date/Seat) is already in your local history.");
                    bookButton.disabled = false;
                    bookButton.textContent = 'Book Ticket Now';
                    return;
                }

                // 3. Add new ticket and save the whole array
                existingTickets.push(newTicket);
                saveTicketsToLocalStorage(existingTickets);
                
                showModal(`Success! Ticket Booked for ${routeDetails.name} on ${selectedDate}, Seat ${selectedSeat}. Price: ${formatPrice(routeDetails.price)}`, true);
                
                // Clear selected seat after successful booking
                window.appState.selectedSeat = null;
                renderSeatMap();

            } catch (error) {
                console.error("Error saving ticket:", error);
                showModal(`Booking Failed: Error saving to local storage.`);
            } finally {
                bookButton.disabled = false;
                bookButton.textContent = 'Book Ticket Now';
            }
        }
        
        // --- UI Rendering and Event Handlers ---

        /** Renders the seat map based on the current state. */
        function renderSeatMap() {
            const { selectedRoute, selectedSeat, routes, bookedSeats } = window.appState;
            const seatMapDiv = document.getElementById('seat-map');
            const routeDetails = routes[selectedRoute];
            const date = window.appState.selectedDate;

            seatMapDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4 p-2 bg-card-light rounded-lg shadow-inner">
                    <span class="font-bold text-lg text-primary">Driver</span>
                    <span class="text-xs text-gray-400">Exit / Door</span>
                </div>
                <div class="seat-map-container">
                    ${routeDetails.seats.map(seat => {
                        // Simulation: Check if seat is globally booked for this route/date
                        const isBooked = (bookedSeats[selectedRoute]?.[date] || []).includes(seat);
                        
                        let className = 'seat seat-available';
                        if (isBooked) {
                            className = 'seat seat-reserved';
                        } else if (seat === selectedSeat) {
                            className = 'seat seat-selected';
                        }
                        
                        return `<div class="${className}" data-seat="${seat}" onclick="handleSeatClick(this, '${seat}')">${seat}</div>`;
                    }).join('')}
                </div>
            `;
            document.getElementById('current-selection').textContent = selectedSeat ? `Seat: ${selectedSeat} | Price: ${formatPrice(routeDetails.price)}` : 'Select a Seat';
        }

        /** Renders the user's booking history from local storage. */
        function renderTicketHistory() {
            const historyDiv = document.getElementById('tickets-history');
            const tickets = loadTicketsFromLocalStorage(); // Load directly when rendering

            if (tickets.length === 0) {
                historyDiv.innerHTML = '<p class="text-center text-gray-400 p-4">No tickets found in your local history. Book one!</p>';
                return;
            }

            historyDiv.innerHTML = tickets.map(ticket => {
                const ticketDate = new Date(ticket.travelDate);
                const isPast = ticketDate < new Date();
                
                return `
                <div class="bg-card-light p-4 rounded-xl shadow-lg mb-3 border-l-4 ${isPast ? 'border-gray-500 opacity-75' : 'border-secondary'}">
                    <p class="font-bold text-lg mb-1">${ticket.routeName}</p>
                    <p class="text-sm text-gray-300">Date: ${ticket.travelDate} | Seat: <span class="text-secondary font-bold">${ticket.seatNumber}</span></p>
                    <p class="text-xs text-gray-400">Booking ID: ${ticket.bookingId}</p>
                    <p class="text-xs text-gray-500">Booked: ${new Date(ticket.creationTime).toLocaleDateString()} ${new Date(ticket.creationTime).toLocaleTimeString()}</p>
                    <p class="text-right font-extrabold text-xl text-primary">${formatPrice(ticket.price)}</p>
                </div>
                `
            }).join('');
        }

        /**
         * Global function to handle seat clicks.
         * @param {HTMLElement} element - The clicked seat div.
         * @param {string} seat - The seat number (e.g., 'A1').
         */
        window.handleSeatClick = (element, seat) => {
            if (element.classList.contains('seat-reserved')) {
                showModal("Sorry, this seat is already reserved.");
                return;
            }

            if (window.appState.selectedSeat === seat) {
                // Deselect
                window.appState.selectedSeat = null;
            } else {
                // Select
                window.appState.selectedSeat = seat;
            }
            renderSeatMap();
        };

        /** Updates the application state when route/date changes. */
        window.handleInputChange = (event) => {
            const { id, value } = event.target;
            
            if (id === 'route-select') {
                window.appState.selectedRoute = value;
            } else if (id === 'date-select') {
                window.appState.selectedDate = value;
            }

            // Reset seat selection on route/date change
            window.appState.selectedSeat = null;

            // --- Scalability/High Traffic Simulation (Simulate one reserved seat for LHE to KHI on 2025-11-20) ---
            if (window.appState.selectedRoute === 'route_lhe_khi' && window.appState.selectedDate === '2025-11-20') {
                 window.appState.bookedSeats = {
                    'route_lhe_khi': {
                        '2025-11-20': ['B3']
                    }
                };
            } else {
                // Default: no seats booked for other dates/routes
                window.appState.bookedSeats = {};
            }
            
            renderSeatMap();
        };

        // --- Utility for custom modal alerts (No window.alert) ---

        function showModal(message, isSuccess = false) {
            const modal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalIcon = document.getElementById('modal-icon');

            modalMessage.textContent = message;
            
            if (isSuccess) {
                modalIcon.innerHTML = `<svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            } else {
                 modalIcon.innerHTML = `<svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
            }, 10);
            
            // Auto-hide after 3 seconds for success messages
            if (isSuccess) {
                setTimeout(hideModal, 3000);
            }
        }
        
        window.hideModal = () => {
             const modal = document.getElementById('custom-modal');
             modal.classList.remove('opacity-100');
             setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- Initial Setup ---
        window.onload = () => {
            // Set initial date selector to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-select').setAttribute('min', today);
            document.getElementById('date-select').value = today;

            // Populate route options
            const routeSelect = document.getElementById('route-select');
            Object.keys(window.appState.routes).forEach(key => {
                const route = window.appState.routes[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${route.name} (${formatPrice(route.price)})`;
                routeSelect.appendChild(option);
            });
            
            // Initial render
            renderSeatMap();
            renderTicketHistory();

            // Attach booking function to button
            document.getElementById('book-button').onclick = bookTicket;
        };
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        
        <!-- Header & Auth Status -->
        <header class="text-center mb-10 p-6 bg-card-light rounded-2xl shadow-3xl border-b-4 border-primary">
            <h1 class="text-4xl font-extrabold text-white mb-2">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">LocalPass</span> Bus Booking
            </h1>
            <p class="text-lg text-gray-300">Fast, Portable, Browser-Stored Booking System</p>
            <p id="user-id-display" class="text-xs mt-3 p-1 bg-bg-dark rounded-full inline-block font-mono text-gray-500">
                Data is stored in your local browser storage.
            </p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Booking Form & Seat Selection (Left/Center Column) -->
            <div class="lg:col-span-2 bg-card-light p-6 md:p-8 rounded-2xl shadow-3xl">
                <h2 class="text-2xl font-bold mb-6 border-b border-gray-700 pb-3 text-primary">1. Plan Your Journey (PKR)</h2>

                <!-- Input Controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="route-select" class="block text-sm font-medium mb-2 text-gray-300">Select Route</label>
                        <select id="route-select" class="w-full p-3 rounded-lg bg-bg-dark border border-gray-600 focus:ring-secondary focus:border-secondary transition" onchange="handleInputChange(event)">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="date-select" class="block text-sm font-medium mb-2 text-gray-300">Select Date</label>
                        <input type="date" id="date-select" class="w-full p-3 rounded-lg bg-bg-dark border border-gray-600 focus:ring-secondary focus:border-secondary transition" onchange="handleInputChange(event)">
                    </div>
                </div>

                <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-3 text-primary">2. Select Your Seat</h2>
                
                <!-- Seat Map Area -->
                <div id="seat-map" class="bg-bg-dark p-6 rounded-xl transition-all duration-300">
                    <!-- Seat Map Renders here -->
                    <p class="text-center text-gray-500">Seat map loading...</p>
                </div>
                
                <!-- Selection Status & Book Button -->
                <div class="mt-6 p-4 bg-primary/20 rounded-xl flex flex-col md:flex-row justify-between items-center border border-primary">
                    <span id="current-selection" class="font-semibold text-xl text-white mb-2 md:mb-0">Select a Seat</span>
                    <button id="book-button" class="px-6 py-3 w-full md:w-auto bg-primary text-white font-bold rounded-lg shadow-xl hover:bg-green-600 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                        Book Ticket Now
                    </button>
                </div>

                <p class="mt-4 text-xs text-gray-400">
                    * Booking is instantly saved to your secure **Local Browser Storage**. Your history persists as long as you don't clear your browser data.
                </p>
            </div>

            <!-- Ticket History (Right Column) -->
            <div class="lg:col-span-1 bg-card-light p-6 md:p-8 rounded-2xl shadow-3xl flex flex-col h-full">
                <h2 class="text-2xl font-bold mb-4 text-secondary">3. Your Local Ticket History</h2>
                <div class="flex-grow overflow-y-auto pr-2" id="tickets-history" style="max-height: 500px;">
                    <p class="text-center text-gray-400">Fetching tickets from local storage...</p>
                    <!-- Tickets render here -->
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700 text-sm text-gray-500">
                    <p>Tickets are retrieved instantly from your browser's local memory.</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Custom Modal for Alerts (Instead of window.alert) -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300 hidden opacity-0" onclick="hideModal()">
        <div class="bg-card-light p-6 rounded-xl shadow-3xl max-w-sm w-full mx-4 transform transition-transform" onclick="event.stopPropagation()">
            <div class="flex items-center mb-4">
                <span id="modal-icon" class="mr-3"></span>
                <h3 class="text-xl font-bold text-white">System Notification</h3>
            </div>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button class="w-full py-2 bg-primary text-white font-semibold rounded-lg hover:bg-green-600 transition" onclick="hideModal()">
                Dismiss
            </button>
        </div>
    </div>

</body>
</html>
